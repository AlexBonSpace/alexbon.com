---
import "@/lib/polyfills/message-channel";
import "@/styles/globals.css";
import JsonLd from "@/components/JsonLd.astro";
import NavigationShell from "@/components/NavigationShell";
import { defaultLocale, locales, type Locale } from "@/i18n/config";
import { contentByLocale, languageLinks } from "@/content";
import { SITE_URL, localeToBcp47 } from "@/lib/seo";
import { messagesByLocale } from "@/lib/messages";
import { DEFAULT_THEME, isThemeId } from "@/lib/themes";
import type { MessageDictionary } from "@/i18n/translator";
import { buildLocalizedPath } from "@/i18n/locale-utils";
import { THEME_COOKIE } from "@/lib/preferences";

type FeedLinks = {
  rss?: string;
  json?: string;
};

type Alternates = Record<string, string>;

type SiteLayoutProps = {
  locale: Locale;
  title?: string;
  description?: string;
  canonical?: string;
  alternates?: Alternates;
  feeds?: FeedLinks;
  jsonLd?: Record<string, unknown> | Record<string, unknown>[];
  bodyClass?: string;
  noIndex?: boolean;
  robots?: string;
  languageAlternates?: Record<string, string>;
  openGraph?: Record<string, string | undefined>;
  twitter?: Record<string, string | undefined>;
  navigationAlternatePaths?: Partial<Record<Locale, string>>;
};

const {
  locale,
  title,
  description,
  canonical,
  alternates,
  feeds,
  jsonLd,
  bodyClass = "",
  noIndex = false,
  robots,
  languageAlternates,
  openGraph,
  twitter,
  navigationAlternatePaths,
} = Astro.props as SiteLayoutProps;

const content = contentByLocale[locale];
const messages = messagesByLocale[locale] as MessageDictionary;
const themeCookieValue = Astro.cookies.get(THEME_COOKIE)?.value;
const initialTheme = isThemeId(themeCookieValue) ? themeCookieValue : DEFAULT_THEME;
const currentPath = Astro.url.pathname;
const currentSearch = Astro.url.search;

function stripLocaleFromPath(pathname: string): string {
  const normalized = pathname.startsWith("/") ? pathname : `/${pathname}`;
  const segments = normalized.split("/").filter(Boolean);
  const first = segments[0];
  if (first && locales.includes(first as Locale)) {
    return `/${segments.slice(1).join("/")}` || "/";
  }
  return normalized || "/";
}

const basePath = stripLocaleFromPath(currentPath);
const autoNavigationAlternates = locales.reduce<Partial<Record<Locale, string>>>((acc, candidate) => {
  acc[candidate] = buildLocalizedPath(basePath, candidate);
  return acc;
}, {});
const searchSuffix =
  currentSearch && currentSearch !== "?"
    ? currentSearch.startsWith("?")
      ? currentSearch
      : `?${currentSearch}`
    : "";

const navigationPaths = {
  ...autoNavigationAlternates,
  ...(navigationAlternatePaths ?? {}),
};

const languageSwitcherLinks = languageLinks.map(({ label, locale: linkLocale }) => {
  const localeKey = linkLocale as Locale;
  const localizedPath = navigationPaths[localeKey] ?? buildLocalizedPath(basePath, localeKey);
  const href = `${localizedPath}${searchSuffix}`.replace(/\?$/, "");
  return {
    label,
    locale: localeKey,
    href,
    isActive: localeKey === locale,
  };
});

const robotsContent =
  typeof robots === "string" && robots.trim()
    ? robots.trim()
    : noIndex
      ? "noindex, nofollow"
      : null;

function escapeForRegExp(value: string): string {
  return value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

const themeCookiePattern = `(?:^|; )${escapeForRegExp(THEME_COOKIE)}=([^;]+)`;
const themeBootstrapScript = `(function() {
  try {
    var stored = localStorage.getItem(${JSON.stringify(THEME_COOKIE)});
    var cookieMatch = document.cookie.match(new RegExp(${JSON.stringify(themeCookiePattern)}));
    var theme = stored || (cookieMatch ? decodeURIComponent(cookieMatch[1]) : ${JSON.stringify(initialTheme)});
    if (theme) {
      document.documentElement.dataset.theme = theme;
    }
  } catch (_) {}
  document.documentElement.classList.add("js");
})();`;

const FEED_LINKS = [
  {
    href: `${SITE_URL}/ua/feed.xml`,
    type: "application/rss+xml",
    title: "Просто простір, щоб видихнути і розібратися",
    hreflang: "uk",
  },
  {
    href: `${SITE_URL}/ua/feed.json`,
    type: "application/feed+json",
    title: "Просто простір, щоб видихнути і розібратися",
    hreflang: "uk",
  },
  {
    href: `${SITE_URL}/ru/feed.xml`,
    type: "application/rss+xml",
    title: "Просто место, чтобы выдохнуть и разобраться",
    hreflang: "ru",
  },
  {
    href: `${SITE_URL}/ru/feed.json`,
    type: "application/feed+json",
    title: "Просто место, чтобы выдохнуть и разобраться",
    hreflang: "ru",
  },
  {
    href: `${SITE_URL}/en/feed.xml`,
    type: "application/rss+xml",
    title: "A lighthouse to see yourself",
    hreflang: "en",
  },
  {
    href: `${SITE_URL}/en/feed.json`,
    type: "application/feed+json",
    title: "A lighthouse to see yourself",
    hreflang: "en",
  },
];

const activeFeeds: Array<{ rel: string; type: string; title: string; href: string; hreflang?: string }> = [];
if (feeds?.rss) {
  activeFeeds.push({
    rel: "alternate",
    type: "application/rss+xml",
    title: "RSS 2.0",
    href: feeds.rss,
    hreflang: localeToBcp47[locale] ?? locale,
  });
}
if (feeds?.json) {
  activeFeeds.push({
    rel: "alternate",
    type: "application/feed+json",
    title: "JSON Feed 1.1",
    href: feeds.json,
    hreflang: localeToBcp47[locale] ?? locale,
  });
}

const FONT_STYLESHEET =
  "https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap&subset=cyrillic";
---
<!DOCTYPE html>
<html lang={localeToBcp47[locale] ?? locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {title ? <title>{title}</title> : null}
    {description ? <meta name="description" content={description} /> : null}
    {canonical ? <link rel="canonical" href={canonical} /> : null}
    {robotsContent ? <meta name="robots" content={robotsContent} /> : null}
    {alternates
      ? Object.entries(alternates).map(([key, value]) => (
          <link rel="alternate" hrefLang={key} href={value} />
        ))
      : null}
    {languageAlternates
      ? Object.entries(languageAlternates).map(([key, value]) => (
          <link rel="alternate" hrefLang={key} href={value} />
        ))
      : null}
    {FEED_LINKS.map((link) => (
      <link rel="alternate" type={link.type} title={link.title} href={link.href} hrefLang={link.hreflang} />
    ))}
    {activeFeeds.map((feed) => (
      <link rel={feed.rel} type={feed.type} title={feed.title} href={feed.href} hrefLang={feed.hreflang} />
    ))}
    {openGraph
      ? Object.entries(openGraph).map(([key, value]) =>
          value ? <meta property={`og:${key}`} content={value} /> : null,
        )
      : null}
    {twitter ? Object.entries(twitter).map(([key, value]) => (value ? <meta name={`twitter:${key}`} content={value} /> : null)) : null}
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
    <link rel="preload" href={FONT_STYLESHEET} as="style" />
    <link rel="stylesheet" href={FONT_STYLESHEET} media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href={FONT_STYLESHEET} />
    </noscript>
    <script is:inline set:html={themeBootstrapScript} />
    {Astro.slots.has("head") ? <slot name="head" /> : null}
    {jsonLd ? <JsonLd data={jsonLd} /> : null}
  </head>
  <body class={`font-sans antialiased ${bodyClass}`}>
    <NavigationShell
      client:idle
      locale={locale}
      brandName={content.brandName}
      tagline={content.tagline}
      messages={messages}
      initialTheme={initialTheme}
      currentPath={currentPath}
      currentSearch={currentSearch}
      alternatePaths={navigationPaths}
      showPrompt={locale === defaultLocale}
    />
    <slot />
    <nav class="language-links language-links--footer" aria-label="Languages">
      <ul class="language-links__list">
        {languageSwitcherLinks.map((link) => (
          <li class="language-links__item" key={link.locale}>
            <a
              href={link.href}
              class={`language-links__link${link.isActive ? " language-links__link--active" : ""}`}
              aria-current={link.isActive ? "page" : undefined}
            >
              {link.label}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  </body>
</html>
