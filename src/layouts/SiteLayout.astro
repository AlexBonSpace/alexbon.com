---
import "@/lib/polyfills/message-channel";
import "@/styles/globals.css";
import { ViewTransitions } from "astro:transitions";
import JsonLd from "@/components/JsonLd.astro";
import NavigationShell from "@/components/NavigationShell";
import { defaultLocale, locales, type Locale } from "@/i18n/config";
import { contentByLocale, languageLinks } from "@/content";
import { SITE_URL, localeToBcp47, hreflangToLocale, DEFAULT_POST_IMAGE } from "@/lib/seo";
import { messagesByLocale } from "@/lib/messages";
import { DEFAULT_THEME } from "@/lib/themes";
import type { MessageDictionary } from "@/i18n/translator";
import { buildLocalizedPath } from "@/i18n/locale-utils";
import { THEME_COOKIE } from "@/lib/preferences";

type FeedLinks = {
  rss?: string;
  json?: string;
};

type Alternates = Record<string, string>;

type SiteLayoutProps = {
  locale: Locale;
  title?: string;
  description?: string;
  canonical?: string;
  alternates?: Alternates;
  feeds?: FeedLinks;
  jsonLd?: Record<string, unknown> | Record<string, unknown>[];
  bodyClass?: string;
  noIndex?: boolean;
  robots?: string;
  languageAlternates?: Record<string, string>;
  openGraph?: Record<string, string | undefined>;
  twitter?: Record<string, string | undefined>;
  navigationAlternatePaths?: Partial<Record<Locale, string>>;
};

const {
  locale,
  title,
  description,
  canonical,
  alternates,
  feeds,
  jsonLd,
  bodyClass = "",
  noIndex = false,
  robots,
  languageAlternates,
  openGraph,
  twitter,
  navigationAlternatePaths,
} = Astro.props as SiteLayoutProps;

const content = contentByLocale[locale];
const messages = messagesByLocale[locale] as MessageDictionary;
const initialTheme = DEFAULT_THEME;
const currentPath = Astro.url.pathname;
const currentSearch = Astro.url.search;

function stripLocaleFromPath(pathname: string): string {
  const normalized = pathname.startsWith("/") ? pathname : `/${pathname}`;
  const segments = normalized.split("/").filter(Boolean);
  const first = segments[0];
  if (first && locales.includes(first as Locale)) {
    const stripped = segments.slice(1).join("/");
    return stripped ? `/${stripped}` : "/";
  }
  return normalized ? normalized : "/";
}

function ensureAbsolutePath(pathname: string): string {
  if (!pathname) {
    return "/";
  }
  return pathname.startsWith("/") ? pathname : `/${pathname}`;
}

function resolveLocalizedNavigationPath(targetLocale: Locale, override: string): string {
  const normalized = ensureAbsolutePath(override);
  if (normalized === "/") {
    return `/${targetLocale}/`;
  }
  if (normalized.startsWith(`/${targetLocale}/`)) {
    return normalized.endsWith("/") ? normalized : `${normalized}/`;
  }
  return buildLocalizedPath(normalized, targetLocale);
}

const basePath = stripLocaleFromPath(currentPath);
const localesWithLocalizedPath = new Set<Locale>([locale]);
if (languageAlternates) {
  for (const key of Object.keys(languageAlternates)) {
    const mappedLocale = hreflangToLocale[key];
    if (mappedLocale) {
      localesWithLocalizedPath.add(mappedLocale);
    }
  }
}

if (navigationAlternatePaths) {
  for (const key of Object.keys(navigationAlternatePaths)) {
    if (locales.includes(key as Locale)) {
      localesWithLocalizedPath.add(key as Locale);
    }
  }
}

const navigationPaths = locales.reduce<Record<Locale, string>>(
  (acc, candidate) => {
    const overridePath = navigationAlternatePaths?.[candidate];
    if (overridePath) {
      acc[candidate] = resolveLocalizedNavigationPath(candidate, overridePath);
      return acc;
    }
    if (localesWithLocalizedPath.has(candidate)) {
      acc[candidate] = buildLocalizedPath(basePath, candidate);
      return acc;
    }
    acc[candidate] = `/${candidate}/`;
    return acc;
  },
  {} as Record<Locale, string>,
);

const searchSuffix =
  currentSearch && currentSearch !== "?" ? (currentSearch.startsWith("?") ? currentSearch : `?${currentSearch}`) : "";

const FULL_FEED_TITLES: Record<Locale, string> = {
  ua: "Alex Bon — повний архів — AI-friendly JSON",
  ru: "Alex Bon — полный архив — AI-friendly JSON",
  en: "Alex Bon — Full archive — AI-friendly JSON",
};

type FeedLink = {
  rel?: string;
  type: string;
  title: string;
  href: string;
  hreflang?: string;
};

const currentHreflang = localeToBcp47[locale] ?? locale;
const baseFeedLinks: FeedLink[] = [
  {
    rel: "alternate",
    href: `${SITE_URL}/${locale}/feed.xml`,
    type: "application/rss+xml",
    title: content.tagline,
    hreflang: currentHreflang,
  },
  {
    rel: "alternate",
    href: `${SITE_URL}/${locale}/feed-full.json`,
    type: "application/feed+json",
    title: FULL_FEED_TITLES[locale],
    hreflang: currentHreflang,
  },
];

const languageSwitcherLinks = languageLinks.map(({ label, locale: linkLocale }) => {
  const localeKey = linkLocale as Locale;
  const localizedPath = navigationPaths[localeKey] ?? buildLocalizedPath("/", localeKey);
  const href = `${localizedPath}${searchSuffix}`.replace(/\?$/, "");
  return {
    label,
    locale: localeKey,
    href,
    isActive: localeKey === locale,
  };
});

const RU_FOOTER_SOCIAL_LINKS = [
  { label: "GitHub", href: "https://github.com/AlexBonSpace/alexbon.com" },
  { label: "Facebook", href: "https://www.facebook.com/AlexBonSpace" },
] as const;

const feedFullUrl = `${SITE_URL}/${locale}/feed-full.json`;
const feedDownloadNode = {
  "@type": "DataDownload",
  "@id": `${feedFullUrl}#download`,
  name: FULL_FEED_TITLES[locale],
  encodingFormat: "application/feed+json",
  contentUrl: feedFullUrl,
  inLanguage: localeToBcp47[locale] ?? locale,
  description: "Plain-text archive feed optimised for AI indexing and research.",
  isAccessibleForFree: true,
};
const websiteJsonLd = {
  "@type": "WebSite",
  "@id": `${SITE_URL}/${locale}/#website`,
  url: `${SITE_URL}/${locale}/`,
  name: content.brandName,
  description: content.metaDescription,
  inLanguage: localeToBcp47[locale] ?? locale,
  potentialAction: {
    "@type": "SearchAction",
    target: `${SITE_URL}/${locale}/search/?q={search_term_string}`,
    "query-input": "required name=search_term_string",
  },
};
const dataFeedJsonLd = {
  "@type": "DataFeed",
  "@id": `${feedFullUrl}#data-feed`,
  name: FULL_FEED_TITLES[locale],
  inLanguage: localeToBcp47[locale] ?? locale,
  url: feedFullUrl,
  license: "https://creativecommons.org/licenses/by/4.0/",
  distribution: [feedDownloadNode],
  isPartOf: websiteJsonLd["@id"],
};
const additionalJsonLd = jsonLd ? (Array.isArray(jsonLd) ? jsonLd : [jsonLd]) : [];
const structuredData = {
  "@context": "https://schema.org",
  "@graph": [websiteJsonLd, dataFeedJsonLd, ...additionalJsonLd],
};

const fallbackTitle = title ?? content.metaTitle ?? content.brandName;
const fallbackDescription = description ?? content.metaDescription ?? content.tagline ?? "";
const fallbackCanonical = canonical ?? `${SITE_URL}/${locale}/`;

const baseOpenGraph: Record<string, string> = {
  type: "website",
  title: fallbackTitle,
  description: fallbackDescription,
  url: fallbackCanonical,
  site_name: content.brandName,
  image: DEFAULT_POST_IMAGE,
};

const resolvedOpenGraph = (() => {
  const merged: Record<string, string> = { ...baseOpenGraph };
  if (openGraph) {
    for (const [key, value] of Object.entries(openGraph)) {
      if (typeof value === "string" && value.trim().length > 0) {
        merged[key] = value;
      }
    }
    if (!openGraph.image) {
      merged.image = baseOpenGraph.image;
    }
  }
  return merged;
})();

const baseTwitter: Record<string, string> = {
  card: "summary_large_image",
  title: fallbackTitle,
  description: fallbackDescription,
  image: resolvedOpenGraph.image,
};

const resolvedTwitter = (() => {
  const merged: Record<string, string> = { ...baseTwitter };
  if (twitter) {
    for (const [key, value] of Object.entries(twitter)) {
      if (typeof value === "string" && value.trim().length > 0) {
        merged[key] = value;
      }
    }
    if (!twitter.image) {
      merged.image = baseTwitter.image;
    }
  }
  return merged;
})();

const robotsContent =
  typeof robots === "string" && robots.trim() ? robots.trim() : noIndex ? "noindex, nofollow" : null;

function escapeForRegExp(value: string): string {
  return value.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

const themeCookiePattern = `(?:^|; )${escapeForRegExp(THEME_COOKIE)}=([^;]+)`;
const themeBootstrapScript = `(function() {
  try {
    var stored = localStorage.getItem(${JSON.stringify(THEME_COOKIE)});
    var cookieMatch = document.cookie.match(new RegExp(${JSON.stringify(themeCookiePattern)}));
    var theme = stored || (cookieMatch ? decodeURIComponent(cookieMatch[1]) : ${JSON.stringify(initialTheme)});
    if (theme) {
      document.documentElement.dataset.theme = theme;
    }
  } catch (_) {}
  document.documentElement.classList.add("js");
})();`;

const contextualFeeds: FeedLink[] = [];
if (feeds?.rss) {
  contextualFeeds.push({
    rel: "alternate",
    type: "application/rss+xml",
    title: content.tagline,
    href: feeds.rss,
    hreflang: currentHreflang,
  });
}
if (feeds?.json) {
  contextualFeeds.push({
    rel: "alternate",
    type: "application/feed+json",
    title: FULL_FEED_TITLES[locale],
    href: feeds.json,
    hreflang: currentHreflang,
  });
}

const feedLinks = Array.from(
  new Map(
    [...baseFeedLinks, ...contextualFeeds].map((feed) => {
      const key = `${feed.type}|${feed.href}`;
      return [key, { rel: "alternate", ...feed }] as const;
    }),
  ).values(),
);

const FONT_STYLESHEET =
  "https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&display=swap&subset=cyrillic";
---

<!doctype html>
<html lang={localeToBcp47[locale] ?? locale}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {title ? <title>{title}</title> : null}
    {description ? <meta name="description" content={description} /> : null}
    {canonical ? <link rel="canonical" href={canonical} /> : null}
    {robotsContent ? <meta name="robots" content={robotsContent} /> : null}
    {
      alternates
        ? Object.entries(alternates).map(([key, value]) => <link rel="alternate" hrefLang={key} href={value} />)
        : null
    }
    {
      languageAlternates
        ? Object.entries(languageAlternates).map(([key, value]) => <link rel="alternate" hrefLang={key} href={value} />)
        : null
    }
    {
      feedLinks.map((link) => (
        <link
          rel={link.rel ?? "alternate"}
          type={link.type}
          title={link.title}
          href={link.href}
          hrefLang={link.hreflang}
        />
      ))
    }
    {
      Object.entries(resolvedOpenGraph).map(([key, value]) =>
        value ? <meta property={`og:${key}`} content={value} /> : null,
      )
    }
    {
      Object.entries(resolvedTwitter).map(([key, value]) =>
        value ? <meta name={`twitter:${key}`} content={value} /> : null,
      )
    }
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossOrigin="anonymous" />
    <link rel="preload" href={FONT_STYLESHEET} as="style" />
    <link rel="stylesheet" href={FONT_STYLESHEET} media="print" onload="this.media='all'" />
    <noscript>
      <link rel="stylesheet" href={FONT_STYLESHEET} />
    </noscript>
    <script is:inline set:html={themeBootstrapScript} />
    {Astro.slots.has("head") ? <slot name="head" /> : null}
    <JsonLd data={structuredData} />
    <ViewTransitions />
  </head>
  <body class={`font-sans antialiased ${bodyClass}`}>
    <NavigationShell
      client:idle
      locale={locale}
      brandName={content.brandName}
      tagline={content.tagline}
      messages={messages}
      initialTheme={initialTheme}
      currentPath={currentPath}
      currentSearch={currentSearch}
      alternatePaths={navigationPaths}
      showPrompt={locale === defaultLocale}
    />
    <slot />
    <footer class="site-footer" aria-label="Footer">
      <div class="site-footer__link-blocks">
        <nav class="language-links language-links--footer" aria-label="Languages">
          <ul class="language-links__list">
            {
              languageSwitcherLinks.map((link) => (
                <li class="language-links__item" key={link.locale}>
                  <a
                    href={link.href}
                    class={`language-links__link${link.isActive ? " language-links__link--active" : ""}`}
                    aria-current={link.isActive ? "page" : undefined}
                  >
                    {link.label}
                  </a>
                </li>
              ))
            }
          </ul>
        </nav>
        {
          locale === "ru" ? (
            <nav class="language-links language-links--footer" aria-label="Социальные сети">
              <ul class="language-links__list">
                {RU_FOOTER_SOCIAL_LINKS.map((link) => (
                  <li class="language-links__item" key={link.href}>
                    <a href={link.href} class="language-links__link" target="_blank" rel="noopener noreferrer">
                      {link.label}
                    </a>
                  </li>
                ))}
              </ul>
            </nav>
          ) : null
        }
      </div>
    </footer>
  </body>
</html>
