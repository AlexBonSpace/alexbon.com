---
import SiteLayout from "@/layouts/SiteLayout.astro";
import SearchApp from "@/components/search/SearchApp";
import { contentByLocale } from "@/content";
import { defaultLocale } from "@/i18n/config";
import { getPostsByLocale } from "@/lib/blog";
import { buildBlogCollectionJsonLd, buildBlogBreadcrumbJsonLd, getBlogIndexMetadata } from "@/lib/blog-schema";
import { messagesByLocale } from "@/lib/messages";
import { translate, type MessageDictionary } from "@/i18n/translator";

const locale = defaultLocale;
const hero = contentByLocale[locale].blog;
const posts = getPostsByLocale(locale);
const meta = getBlogIndexMetadata(locale, "/search/");
const jsonLd = [buildBlogCollectionJsonLd(locale, posts), buildBlogBreadcrumbJsonLd(locale)];

const messages = messagesByLocale[locale] as MessageDictionary;

const appId = import.meta.env.PUBLIC_ALGOLIA_APP_ID;
if (!appId) {
  throw new Error("PUBLIC_ALGOLIA_APP_ID is required to render the search page.");
}

const searchApiKey = import.meta.env.PUBLIC_ALGOLIA_SEARCH_API_KEY;
if (!searchApiKey) {
  throw new Error("PUBLIC_ALGOLIA_SEARCH_API_KEY is required to render the search page.");
}

const indexName =
  import.meta.env.PUBLIC_ALGOLIA_INDEX_NAME_UA ?? import.meta.env.PUBLIC_ALGOLIA_INDEX_NAME;
if (!indexName) {
  throw new Error("PUBLIC_ALGOLIA_INDEX_NAME (or ALGOLIA_INDEX_NAME) must be provided.");
}

const searchQuery =
  Astro.url.searchParams.get("search") ??
  Astro.url.searchParams.get("q") ??
  "";

const readMoreLabel = translate(messages, "Blog.readMore");

const pick = (key: string, fallback: string) => {
  const value = translate(messages, key);
  return value === key ? fallback : value;
};

const searchCopy = {
  label: pick("Search.label", "Пошук по блогу"),
  placeholder: pick("Search.placeholder", "Введіть тему, наприклад «тривога» або «втома»"),
  reset: pick("Search.reset", "Скинути"),
  noscript: pick(
    "Search.noscript",
    "Щоб пошук працював, увімкніть JavaScript. Нижче показані всі записи.",
  ),
  empty: pick("Search.empty", "Нічого не знайдено"),
  emptyDetails: pick("Search.emptyDetails", "Спробуйте сформулювати запит інакше або скиньте пошук."),
  readMore: readMoreLabel,
  pagination: {
    previous: pick("Pagination.previous", "Назад"),
    next: pick("Pagination.next", "Вперед"),
    summaryTemplate: pick("Pagination.pageSummary", "Сторінка {current} з {total}"),
  },
} as const;

const pageTitle = pick("Search.pageTitle", "Пошук");
const pageDescription = pick("Search.pageDescription", hero.heroDescription);
const heroTitle = pick("Search.heroTitle", "Пошук по блогу");
const heroDescription = pick(
  "Search.heroDescription",
  "Результати з’являтимуться в міру введення запиту. Для швидкого старту нижче показані останні матеріали.",
);
---
<SiteLayout
  locale={locale}
  title={pageTitle}
  description={pageDescription}
  canonical={meta.canonical}
  languageAlternates={meta.alternates}
  feeds={meta.feeds}
  jsonLd={jsonLd}
>
  <main class="relative z-10 flex flex-col gap-8 py-8 sm:py-12">
    <div class="mx-auto w-[92%] max-w-6xl px-4 sm:px-6">
      <section class="section-card-strong flex flex-col gap-4 rounded-[2.5rem] border border-soft p-6 text-center shadow-card sm:p-10">
        <h1 class="text-balance text-[clamp(2.1rem,6vw,3.4rem)] font-semibold leading-tight text-strong">
          {heroTitle}
        </h1>
        <p class="mx-auto max-w-2xl text-[clamp(1rem,3vw,1.2rem)] leading-relaxed text-primary">
          {heroDescription}
        </p>
      </section>
    </div>

    <div class="mx-auto w-[92%] max-w-6xl px-4 sm:px-6">
      <SearchApp
        client:load
        appId={appId}
        searchApiKey={searchApiKey}
        indexName={indexName}
        locale={locale}
        initialQuery={searchQuery}
        copy={searchCopy}
      />
    </div>
  </main>
</SiteLayout>
