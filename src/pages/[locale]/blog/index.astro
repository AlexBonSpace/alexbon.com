---
import SiteLayout from "@/layouts/SiteLayout.astro";
import PostGrid from "@/components/blog/PostGrid.astro";
import { locales, type Locale } from "@/i18n/config";
import { contentByLocale } from "@/content";
import { paginateSummaries, getSummariesByLocale } from "@/lib/post-summaries";
import {
  buildBlogCollectionJsonLd,
  buildBlogBreadcrumbJsonLd,
  getBlogIndexMetadata,
} from "@/lib/blog-schema";
import { messagesByLocale } from "@/lib/messages";
import { notFound } from "@/lib/http";
import { translate, type MessageDictionary } from "@/i18n/translator";
import { toExplorerPosts } from "@/lib/blog-explorer";
import HeroReflection from "@/components/HeroReflection.astro";

export const prerender = true;

export function getStaticPaths() {
  return locales.map((locale) => ({
    params: { locale },
  }));
}

const localeParam = Astro.params.locale?.toLowerCase() as Locale | undefined;
if (!localeParam || !locales.includes(localeParam)) {
  return notFound();
}

const locale = localeParam;
const hero = contentByLocale[locale].blog;
const allPosts = getSummariesByLocale(locale);
const firstPage = paginateSummaries(locale, 1);
const pagePosts = toExplorerPosts(firstPage.items, locale);
const meta = getBlogIndexMetadata(locale);
const jsonLd = [buildBlogCollectionJsonLd(locale, allPosts), buildBlogBreadcrumbJsonLd(locale)];

const messages = messagesByLocale[locale] as MessageDictionary;

const introCopyByLocale: Record<Locale, string> = {
  ua: "Мене звати Алек Бон. Я психолог і письменник з України. У світі, сповненому шуму, я пишу тихі історії. Щоб ви могли почути себе.",
  ru: "Меня зовут Алек Бон. Я психолог и писатель из Украины. В мире, полном шума, я пишу тихие истории. Чтобы вы могли услышать себя.",
  en: "My name is Alec Bon. I am a psychologist and writer from Ukraine. In a world full of noise, I write quiet stories so you can hear yourself.",
};
const introCopy = hero.heroDescription ? null : introCopyByLocale[locale];

const readMoreRaw = translate(messages, "Blog.readMore");
const readMoreLabel =
  readMoreRaw === "Blog.readMore"
    ? locale === "ru"
      ? "Читать дальше"
      : locale === "en"
        ? "Read more"
        : "Читати далі"
    : readMoreRaw;

const paginationSummary = translate(messages, "Pagination.pageSummary", {
  page: firstPage.page,
  total: firstPage.totalPages,
});
const previousLabel = translate(messages, "Pagination.previous");
const nextLabel = translate(messages, "Pagination.next");
const prefix = `/${locale}`;
---
<SiteLayout
  locale={locale}
  title={hero.heroTitle}
  description={hero.heroDescription || undefined}
  canonical={meta.canonical}
  languageAlternates={meta.alternates}
  feeds={meta.feeds}
  jsonLd={jsonLd}
>
  <main class="relative z-10 flex flex-col gap-10 py-8 sm:py-12">
    <div class="mx-auto w-full max-w-6xl px-4 sm:px-6">
      <HeroReflection
        badge={hero.badge}
        title={hero.heroTitle}
        description={hero.heroDescription}
        introCopy={introCopy}
      />
    </div>

    <div class="mx-auto w-full max-w-6xl px-4 sm:px-6">
      <PostGrid
        posts={pagePosts}
        readMoreLabel={readMoreLabel}
        pagination={
          firstPage.totalPages > 1
            ? {
                currentPage: firstPage.page,
                totalPages: firstPage.totalPages,
                basePath: `${prefix}/blog/`,
                summary: paginationSummary,
                previousLabel,
                nextLabel,
              }
            : undefined
        }
      />
    </div>
  </main>
</SiteLayout>
