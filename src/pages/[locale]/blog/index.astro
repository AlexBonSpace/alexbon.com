---
import SiteLayout from "@/layouts/SiteLayout.astro";
import TypeSection from "@/components/blog/TypeSection.astro";
import { locales, type Locale } from "@/i18n/config";
import { contentByLocale } from "@/content";
import { getSummariesByLocale, getSummariesByType } from "@/lib/post-summaries";
import { buildBlogCollectionJsonLd, buildBlogBreadcrumbJsonLd, getBlogIndexMetadata } from "@/lib/blog-schema";
import { messagesByLocale } from "@/lib/messages";
import { notFound } from "@/lib/http";
import { translate, type MessageDictionary } from "@/i18n/translator";
import { toExplorerPosts } from "@/lib/blog-explorer";
import HeroReflection from "@/components/HeroReflection.astro";
import { type PostType, getPostTypeLabel, getPostTypeShortDescription, buildPostTypePath } from "@/lib/post-types";

export const prerender = true;

export function getStaticPaths() {
  return locales.map((locale) => ({
    params: { locale },
  }));
}

const localeParam = Astro.params.locale?.toLowerCase() as Locale | undefined;
if (!localeParam || !locales.includes(localeParam)) {
  return notFound();
}

const locale = localeParam;
const hero = contentByLocale[locale].blog;
const allPosts = getSummariesByLocale(locale);
const meta = getBlogIndexMetadata(locale);
const jsonLd = [buildBlogCollectionJsonLd(locale, allPosts), buildBlogBreadcrumbJsonLd(locale)];

const messages = messagesByLocale[locale] as MessageDictionary;

const readMoreRaw = translate(messages, "Blog.readMore");
const readMoreLabel =
  readMoreRaw === "Blog.readMore"
    ? locale === "ru"
      ? "Читать дальше"
      : locale === "en"
        ? "Read more"
        : "Читати далі"
    : readMoreRaw;

const viewAllRaw = translate(messages, "Blog.viewAll");
const viewAllLabel =
  viewAllRaw === "Blog.viewAll"
    ? locale === "ru"
      ? "Смотреть все"
      : locale === "en"
        ? "View all"
        : "Дивитися все"
    : viewAllRaw;

const POSTS_PER_SECTION = 3;
const TYPE_ORDER: PostType[] = ["note", "story", "article", "okna"];

const sections = TYPE_ORDER.map((type) => ({
  type,
  posts: toExplorerPosts(getSummariesByType(locale, type).slice(0, POSTS_PER_SECTION), locale),
  label: getPostTypeLabel(locale, type),
  description: getPostTypeShortDescription(locale, type),
  typeUrl: buildPostTypePath(locale, type),
})).filter((section) => section.posts.length > 0);
---

<SiteLayout
  locale={locale}
  title={hero.metaTitle || hero.heroTitle}
  description={meta.description || undefined}
  canonical={meta.canonical}
  languageAlternates={meta.alternates}
  feeds={meta.feeds}
  jsonLd={jsonLd}
>
  <main class="relative z-10 flex flex-col gap-10 py-8 sm:py-12">
    <div class="mx-auto w-full max-w-6xl px-4 sm:px-6">
      <HeroReflection title={hero.heroTitle} description={hero.heroDescription} actionButton={hero.aboutButton} />
    </div>

    <div class="mx-auto flex w-full max-w-6xl flex-col gap-10 px-4 sm:gap-12 sm:px-6">
      {
        sections.map((section, index) => (
          <TypeSection
            type={section.type}
            posts={section.posts}
            label={section.label}
            description={section.description}
            typeUrl={section.typeUrl}
            readMoreLabel={readMoreLabel}
            viewAllLabel={viewAllLabel}
            index={index}
          />
        ))
      }
    </div>
  </main>
</SiteLayout>
