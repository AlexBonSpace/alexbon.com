---
import SiteLayout from "@/layouts/SiteLayout.astro";
import PostGrid from "@/components/blog/PostGrid.astro";
import TypeHero from "@/components/blog/TypeHero.astro";
import { locales, type Locale } from "@/i18n/config";
import { getSummariesByType, paginateSummariesByType } from "@/lib/post-summaries";
import {
  buildPostTypeRelativePath,
  getPostTypeDescription,
  getPostTypeLabel,
  isValidPostType,
  type PostType,
} from "@/lib/post-types";
import { buildCanonicalUrl, buildLanguageAlternates, SITE_URL, localeToBcp47 } from "@/lib/seo";
import { messagesByLocale } from "@/lib/messages";
import { translate, type MessageDictionary } from "@/i18n/translator";
import { notFound } from "@/lib/http";
import { toExplorerPosts } from "@/lib/blog-explorer";

export const prerender = true;

export function getStaticPaths() {
  const paths: Array<{ params: { locale: string; type: string } }> = [];
  for (const locale of locales) {
    for (const type of ["note", "article", "story", "okno"] as const) {
      paths.push({ params: { locale, type } });
    }
  }
  return paths;
}

const localeParam = Astro.params.locale?.toLowerCase() as Locale | undefined;
const rawType = Astro.params.type;

if (!localeParam || !locales.includes(localeParam) || !rawType || !isValidPostType(rawType)) {
  return notFound();
}

const locale = localeParam;
const type = rawType as PostType;
const pagination = paginateSummariesByType(locale, type, 1);

if (pagination.totalCount === 0) {
  return notFound();
}

const postsView = toExplorerPosts(pagination.items, locale);
const label = getPostTypeLabel(locale, type);
const description = getPostTypeDescription(locale, type, pagination.totalCount);
const relativePath = buildPostTypeRelativePath(type);
const canonical = buildCanonicalUrl(locale, relativePath);
const availableLocales = locales.filter((candidate) => getSummariesByType(candidate, type).length > 0);
const languageAlternates = buildLanguageAlternates(
  availableLocales.reduce<Record<Locale, string>>(
    (acc, candidate) => {
      acc[candidate] = relativePath;
      return acc;
    },
    {} as Record<Locale, string>,
  ),
  { locales: availableLocales },
);
const sameAs = Object.values(languageAlternates).filter((url) => url !== canonical);

const messages = messagesByLocale[locale] as MessageDictionary;
const readMoreRaw = translate(messages, "Blog.readMore");
const readMoreLabel =
  readMoreRaw === "Blog.readMore"
    ? locale === "ru"
      ? "Читать дальше"
      : locale === "en"
        ? "Read more"
        : "Читати далі"
    : readMoreRaw;
const previousLabel = translate(messages, "Pagination.previous");
const nextLabel = translate(messages, "Pagination.next");
const pageSummary = translate(messages, "Pagination.pageSummary", {
  page: pagination.page,
  total: pagination.totalPages,
});

const prefix = `/${locale}`;
---

<SiteLayout
  locale={locale}
  title={label}
  description={description}
  canonical={canonical}
  languageAlternates={languageAlternates}
  jsonLd={[
    {
      "@context": "https://schema.org",
      "@type": "CollectionPage",
      name: label,
      inLanguage: localeToBcp47[locale],
      description,
      url: canonical,
      isPartOf: `${SITE_URL}/${locale}/blog/`,
      sameAs,
      about: {
        "@type": "DefinedTerm",
        name: label,
        inDefinedTermSet: `${SITE_URL}/${locale}/blog/type`,
      },
    },
  ]}
>
  <main class="relative z-10 flex flex-col gap-10 py-8 sm:py-12">
    <div class="mx-auto w-full max-w-6xl px-4 sm:px-6">
      <TypeHero type={type} label={label} description={description} />
    </div>

    <div class="mx-auto w-full max-w-6xl px-4 sm:px-6">
      <PostGrid
        posts={postsView}
        readMoreLabel={readMoreLabel}
        sectionType={type}
        pagination={{
          currentPage: pagination.page,
          totalPages: pagination.totalPages,
          basePath: `${prefix}${buildPostTypeRelativePath(type)}`,
          summary: pageSummary,
          previousLabel,
          nextLabel,
        }}
      />
    </div>
  </main>
</SiteLayout>
