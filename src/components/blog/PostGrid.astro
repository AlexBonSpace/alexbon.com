---
import type { ExplorerPostView } from "@/lib/blog-explorer";
import type { PostType } from "@/lib/post-types";

type PaginationMeta = {
  currentPage: number;
  totalPages: number;
  basePath: string;
  summary: string;
  previousLabel: string;
  nextLabel: string;
};

interface PostGridProps {
  posts: ExplorerPostView[];
  readMoreLabel: string;
  pagination?: PaginationMeta;
  /** If set, applies this type's accent color to the entire grid container */
  sectionType?: PostType;
  /** If true, applies per-card accent based on each post's type (default: false) */
  perCardAccent?: boolean;
}

const { posts, readMoreLabel, pagination, sectionType, perCardAccent = false } = Astro.props as PostGridProps;

// Helper to get accent class for a post type
const getTypeAccentClass = (type: PostType) => `type-accent--${type}`;

const ensureTrailingSlash = (value: string) => (value.endsWith("/") ? value : `${value}/`);

const buildPageHref = (basePath: string, page: number) => {
  const normalizedBase = basePath === "/" ? "/" : ensureTrailingSlash(basePath);
  if (page <= 1) {
    return normalizedBase;
  }
  return `${normalizedBase}page/${page}/`;
};
---

<section class:list={["flex flex-col gap-6", sectionType && getTypeAccentClass(sectionType)]}>
  {
    posts.length > 0 ? (
      <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
        {posts.map((post) => {
          // Determine the accent class for this card
          const cardAccentClass = perCardAccent ? getTypeAccentClass(post.type) : "";
          // Apply accent-card class when either sectionType is set or perCardAccent is true
          const hasAccent = sectionType || perCardAccent;

          return post.type === "note" ? (
            <article
              class:list={[
                "blog-card flex w-full flex-col gap-3 rounded-3xl border border-soft p-5 transition-transform duration-200 hover:-translate-y-0.5 sm:p-6",
                hasAccent && "accent-card",
                cardAccentClass,
              ]}
              key={post.slug}
            >
              <div class="flex items-center text-xs font-semibold uppercase tracking-[0.28em] text-muted">
                <a
                  href={ensureTrailingSlash(post.typeUrl)}
                  class="badge-soft inline-flex items-center px-3 py-1 text-[0.65rem] leading-none transition-colors hover:bg-[#f2993f]/90 hover:text-white"
                >
                  {post.typeLabel}
                </a>
              </div>
              <h2 class="sr-only">{post.title}</h2>
              <p class="whitespace-pre-line text-[clamp(1.1rem,3vw,1.2rem)] leading-relaxed text-strong">
                {post.snippet || post.title}{" "}
                <a
                  href={ensureTrailingSlash(post.url)}
                  class="inline-flex items-center text-[1.05em] text-accent/80 transition-colors hover:text-accent focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-accent"
                  aria-label={readMoreLabel}
                >
                  <span aria-hidden="true">ü¶ã</span>
                </a>
              </p>
            </article>
          ) : (
            <article
              class:list={[
                "blog-card flex w-full flex-col gap-5 rounded-[2.5rem] border border-soft p-6 transition-transform duration-200 hover:-translate-y-1 sm:p-8",
                hasAccent && "accent-card",
                cardAccentClass,
              ]}
              key={post.slug}
            >
              <div class="flex items-center text-xs font-semibold uppercase tracking-[0.28em] text-muted">
                <a
                  href={ensureTrailingSlash(post.typeUrl)}
                  class="badge-soft inline-flex items-center gap-2 rounded-full px-3 py-1 text-[0.65rem] leading-none transition-colors hover:bg-[#f2993f]/90 hover:text-white"
                >
                  {post.typeLabel}
                </a>
              </div>
              <div class="flex flex-col gap-3">
                <h2 class="text-center text-[clamp(1.45rem,4vw,1.85rem)] font-semibold leading-tight text-strong">
                  <a href={ensureTrailingSlash(post.url)} class="text-inherit transition-colors hover:text-accent">
                    {post.title}
                  </a>
                </h2>
                {post.snippet ? (
                  <p class="whitespace-pre-line text-[clamp(1.1rem,3vw,1.2rem)] leading-relaxed text-primary">
                    {post.snippet}
                  </p>
                ) : null}
              </div>
              <div>
                <a
                  href={ensureTrailingSlash(post.url)}
                  class="button-primary inline-flex items-center gap-2 rounded-full px-4 py-2 text-sm font-semibold transition-transform hover:-translate-y-0.5"
                >
                  {readMoreLabel}
                  <span aria-hidden="true">‚Üí</span>
                </a>
              </div>
            </article>
          );
        })}
      </div>
    ) : (
      <div class="blog-card col-span-full flex flex-col items-center gap-3 rounded-[2rem] border border-soft p-10 text-center text-primary">
        <p class="text-xl font-semibold text-strong">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>
        <p class="text-sm text-muted">–°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ ‚Äî —Å—Ç–∞—Ç—Ç—ñ –¥–ª—è —Ü—ñ—î—ó –≤–∏–±—ñ—Ä–∫–∏ —â–µ –≥–æ—Ç—É—é—Ç—å—Å—è.</p>
      </div>
    )
  }

  {
    pagination && pagination.totalPages > 1 ? (
      <nav class="flex items-center justify-between rounded-full border border-soft bg-surface px-4 py-2 text-sm font-semibold text-primary shadow-card">
        {pagination.currentPage > 1 ? (
          <a
            href={buildPageHref(pagination.basePath, pagination.currentPage - 1)}
            class="flex items-center gap-2 rounded-full px-3 py-2 transition-colors hover:bg-accent/10 hover:text-accent"
          >
            ‚Üê {pagination.previousLabel}
          </a>
        ) : (
          <span class="cursor-not-allowed rounded-full px-3 py-2 text-disabled opacity-70">‚Üê</span>
        )}
        <span class="text-xs uppercase tracking-[0.3em] text-muted">{pagination.summary}</span>
        {pagination.currentPage < pagination.totalPages ? (
          <a
            href={buildPageHref(pagination.basePath, pagination.currentPage + 1)}
            class="flex items-center gap-2 rounded-full px-3 py-2 transition-colors hover:bg-accent/10 hover:text-accent"
          >
            {pagination.nextLabel} ‚Üí
          </a>
        ) : (
          <span class="cursor-not-allowed rounded-full px-3 py-2 text-disabled opacity-70">‚Üí</span>
        )}
      </nav>
    ) : null
  }
</section>
