## alexbon.com (Astro rebuild)

**Stack & Tooling**
- Astro 5 running in server mode with the Cloudflare Pages adapter (`@astrojs/cloudflare`).
- React islands handle interactivity (navbar, search page, theme toggle) marked with `client:*`.
- Tailwind CSS v4 + custom tokens in `src/styles/globals.css`.
- Algolia is optional: used only for interactive search; indexing happens via `scripts/push-algolia.mjs` that reads locale feeds from `dist/*/feed-full*.json`.
- Content sources:
  - Markdown/MDX pulled via Astro Content collections (`src/content`).
  - Translation-aware helpers in `src/lib/pages.ts` and `src/lib/blog.ts`.

**Project Layout**
- `src/pages` – Astro routes mirroring `/`, `/about`, `/blog`, `/search`, feeds, sitemap.
- `src/components` – shared React/Astro components; `NavigationShell` hosts navbar + language prompt.
- `src/lib` – data loaders, SEO helpers, search mappers.
- `src/contexts` – lightweight React providers for theme & i18n (used by islands).
- `src/messages` – JSON translation dictionaries.
- `src/styles` – global Tailwind setup and design tokens.

**Key Behaviors**
- "Only [locale]" routing: each locale lives under its own prefix (`/ua/…`, `/ru/…`, `/en/…`). The bare root `/` uses SSR for instant locale detection (cookie → Accept-Language → fallback) and 308-redirects accordingly. Locale roots redirect to the local blog index.
- **Prerendering strategy**: Content pages use `export const prerender = true` (except root `/`) to generate static HTML at build time
  - Blog posts (`/[locale]/blog/[slug]/`), tag pages, search page - all prerendered
  - Root `/` uses SSR with `resolveRequestLocale` for intelligent redirect
  - MDX content NOT loaded into worker bundle, only rendered to static HTML
  - Worker bundle contains only runtime code + metadata cache (~1.5 MB for 138 posts)
- Blog listings/search/tag/type pages consume the build-time cache in `src/lib/.cache/post-summaries.json` (generated by `scripts/build-cache.mjs`) instead of calling `getCollection` in the worker, minimizing worker bundle size.
- **Cache optimization**: Post summaries store only essential metadata (title, description, tags, URLs, dates) without full post text. This keeps the cache small (~235 KB for 138 posts) and the worker bundle under Cloudflare's 5MB limit even with 500+ posts (~2.2 MB projected). Full text is read directly from MDX during build for feeds.
- **Routes optimization**: `scripts/normalize-routes.mjs` runs automatically after build (via `postbuild` hook) to optimize `_routes.json` for Cloudflare's 100-rule limit. It converts 99 individual exclude entries (one per post/page) into 24 optimized rules (6 static assets + 18 wildcards like `/{locale}/blog/*`). This allows blog posts to be served from CDN instead of Worker, reducing Worker invocations and staying well under the 100k/day free tier request limit.
- Updated timestamps are manual: keep each MDX `updatedAt` equal to `publishedAt` unless the content materially changes. There is no automated sync with git history anymore.
- Sessions use the lightweight cookie driver; set `ASTRO_SESSION_SECRET` (e.g. `openssl rand -base64 32`) in production so cookies подписываются безопасно. Локально используется dev-secret, но для Pages нужно прокинуть переменную окружения.
- `src/lib/.cache` is generated — never edit by hand; rerun `npm run cache:build` when content changes without restarting dev server.
- Mobile layout now uses full-width (`w-full`) containers with padding instead of `w-[92%]`, and story/article text shares the larger clamp used for notes (`clamp(1.1rem, 3.2vw, 1.3rem)`).
- Rel=me and sameAs now point to GitHub (`https://github.com/AlexBonSpace/alexbon.com`); Mastodon profile links were removed from head metadata and content defaults.
- Language menu & browser prompt use `navigationAlternatePaths` to deep-link translated slugs.
- Theme preference stored in cookie + localStorage (`ALEXBON_THEME`).
- `/[locale]/search/` renders SSR fallback with recent posts, `robots="noindex, follow"`, and loads the Algolia-powered React app lazily (no request until the user types).
- Sitemap + feeds (`/sitemap.xml.ts`, `/feed.xml.ts`, `/feed-full.json.ts`, `/feed-full-page-[page].json.ts`) имеют `export const prerender = true` и генерируются статически во время build, поэтому Cloudflare отдаёт их без SSR-нагрузки. RSS feed рендерит HTML-контент из MDX через `getPostsByLocale()`, а JSON feeds читают полный текст напрямую из MDX (не из кеша), собирая плоский `content_text` на 500 записей на страницу, отсортированный по `date_modified`.
- Shared 404 handling: `src/lib/http.ts` returns the HTML from `src/components/system/not-found.html`, the same markup served by `src/pages/404.astro`, so SSR fallbacks show the branded error page.

**Commands**
- `npm run dev` – Astro dev server with SSR on Cloudflare shim.
- `npm run build` – Cloudflare SSR bundle + prerendered feeds/sitemap (run before syncing Algolia or deploying).
- `npm run preview` – local preview of the SSR build.
- `npm run cache:build` – regenerate `src/lib/.cache/post-summaries.json` (runs automatically before dev/build; rerun manually if content changes mid-session).
- `npm run lint` – run ESLint to check code quality.
- `npm run lint:fix` – run ESLint and automatically fix issues.
- `npm run format` – format all code with Prettier.
- `npm run format:check` – check if code is formatted correctly.
- `npm run test` – executes the Vitest suite (unit helpers + future component tests).
- `npm run test:watch` – watch mode for the Vitest suite during development.
- `npm run verify:seo` – check the built sitemap for banned URLs/duplicates/trailing slashes (requires running `npm run build` first).
- `npm run verify` – runs security audit, Vitest suite, build, and `verify:seo` for complete validation.
- `npm run algolia:sync` – optional; parses all `dist/*/feed-full*.json` pages (follow `next_url`), diffs against `scripts/.algolia-cache.json`, and pushes only changed Algolia records (requires env keys).
- `npm run algolia:sync -- --full` – optional; force a full Algolia reindex and refresh the cache manifest.
- `npx wrangler pages deploy dist` – deploy to Cloudflare Pages Functions.
- `astro add <integration> --yes` – add Astro integrations without interactive prompts (AI agent-friendly). Examples: `astro add react --yes`, `astro add tailwind --yes`. Perfect for Claude Code, Cursor, Copilot and other AI-assisted development tools.

**Automation**
- Pre-commit hooks (Husky) automatically run lint, tests, and security audit before each commit.
- GitHub Actions CI runs full validation on every push to main/master/claude branches.
- VS Code auto-formats code on save (configured in `.vscode/settings.json`).

**Algolia Sync Notes**
- Incremental mode keeps a manifest at `scripts/.algolia-cache.json` (ignored by git); reruns only push changed/removed records.
- Full mode (`--full`) replaces the entire index via `replaceAllObjects` and rebuilds the manifest, matching the legacy behaviour.
